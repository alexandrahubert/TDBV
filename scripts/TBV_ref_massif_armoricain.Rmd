---
title: "Hydromorphologie des cours d'eau en têtes de bassin versant"
author: "Pascal IRZ, Julien BOËTON, Alexandra HUBERT, Mikaël LE BIHAN - OFB, Direction
  Régionale Bretagne
  Gabriel MELUN - OFB, Direction de la recherche et de l'appui scientifique"
date: "`r format(Sys.time(), 'Le %d/%m/%Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    tab_caption: yes
    number_sections: yes
    global_numbering: yes
    toc: yes
    toc_float:
      toc_collapsed: yes
      toc_depth: 2
    code_folding: hide
    css: "style.css"
    
  word_document: default
  pdf_document: default
subtitle: Analyses préliminaires sur les stations de cours d'eau de référence hydromorphologique de l'hydroécorégion de niveau 1 "Massif Armoricain"
runtime: shiny
resource_files:
- www/favicon.ico
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# chargement des packages
library(dplyr)
library(tidyr)
library(tibble)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(plotly)
library(flextable)
library(shiny)
library(bookdown)
```

```{r, echo = FALSE}
htmltools::img(src = knitr::image_uri('logo_OFB.jpg'),
               alt = 'logo',
               style = 'position:absolute; top:0; right:0; padding:0px; width:100px;')

# use_favicon()
# golem::use_favicon("www/favicon.ico")
```

>Mots-clés : cours d’eau ; hydromorphologie ; lit mineur ; conditions naturelles ; restauration ; têtes de bassin versant

# Introduction

Cette page thématique présente une analyse préliminaire des caractéristiques hydromorphologique des cours d'eau en têtes de bassin versant, réalisée par la Direction régionale Bretagne de l'Office Français de la Biodiversité. Elle vise à fournir des éléments de connaissance sur les caractéristiques hydromorphologiques des cours d’eau sur des stations proches des conditions naturelles (peu ou pas impactées) dans l’HydroEcoRégion (HER) de niveau 1 « Massif Armoricain ». L'établissement et la connaissance de ces données de référence est de nature à améliorer l’efficacité des opérations de restauration écologique de cours d’eau sur ce territoire.

:::: {.defbox data-latex=""}

Les cours d’eau en têtes de bassin versant se localisent à l’extrémité amont du réseau hydrographique. La classification de Strahler (Strahler, 1957) a été majoritairement utilisée dans le cadre des études tendant à définir spatialement ces cours d’eau en têtes de bassin (Tixier et al., 2012). Cette classification est fondée sur l’importance croissante des branches qui constituent le réseau hydrographique. En France métropolitaine, et dans la plupart des Schémas Directeurs d'Aménagement et de Gestion des Eaux (SDAGE), sont considérés en têtes de bassin, les cours d’eau de rang de Strahler 1 et 2 à l’échelle 1 : 25 000$^{ème}$.

::::


Des données ont été collectées par l'OFB dans le cadre de stages de Master 2 entre 2013 et 2019 sur des cours d’eau qualifiés de "non impactés" vis à vis de leurs caractéristiques hydromorphologiques (Jan, 2013 ; Bossis, 2014 ; Gallineau, 2020). Le protocole de terrain mis en œuvre à l’échelle stationnelle visait à recueillir les principales caractéristiques hydromorphologiques du lit mineur et de la ripisylve sur des stations localisées sur des cours d'eau de rang de Strahler de 1 à 4, avec une majorité de cours d'eau de rang de Strahler 1. Les caractéristiques principales des bassins versants en amont des tronçons ont été obtenues par géotraitement sous le logiciel QGis.

Afin de mettre en perspective les résultats obtenus sur ce jeu de données de la direction Bretagne de l’OFB, les mêmes analyses ont été menées sur les stations qualifiées "de référence" de [l'IED Carhyce](https://analytics.huma-num.fr/ied_carhyce/) sur la même HydroEcoRégion. Les protocoles de terrain de ces différents jeux de données ne sont pas identiques, cependant certains paramètres sont similaires et se recoupent.

```{r}
# chargement du tableau de données au format RData
load(file = "ref.RData")

# chargement des graphiques au format RData
load(file = "graphiques.RData")

# chargement des fonctions
source(file = "00_fonctions.R")
```
Le tableau assemblé comprend au total `r nrow(ref)` lignes correspondant à 1) `r ref %>% filter(jeu_donnees != 'carhyce_ref_armo') %>% nrow()` stations localisées sur les cours d'eau étudiés par la DR Bretagne et 2) `r ref %>% filter(jeu_donnees == 'carhyce_ref_armo') %>% nrow()` stations dont les données proviennent de [l'IED Carhyce](https://analytics.huma-num.fr/ied_carhyce/) (Table 1).

Dans le détail, 3 jeux de données peuvent être distingués dans les analyses suivantes, en lien notamment avec un critère de nombre de stations :

- le jeu de données « têtes de bassins de référence » issu des travaux de Jan (2013) et Bossis (2014) sur des cours d’eau de rang 1 en Bretagne et Pays de la Loire (n=`r n_sites_par_source[3,2]`  stations) ;
- le jeu de données issu des travaux de Galineau (2020) sur des cours d’eau de rang 1 à 4 en Bretagne et Pays de la Loire (n=`r n_sites_par_source[2,2]` stations)  ;
- le jeu de données issu de Carhyce, intégrant des cours d’eau plus importants, de rang 1 à X sur l'HydroEcoRégion "Massif Armoricain" (n=`r n_sites_par_source[1,2]` stations). 


```{r tab:table1}
ref %>%
  downloadthis::download_this(
    output_name = "hydromorpho_ref_armo",
    output_extension = ".xlsx",
    button_label = "Télécharger en Excel",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-save",
    csv2 = TRUE,
  )

ref %>% 
  select(-Code_tron,
         -dist_inter_rad,
         -Coef_sinuo) %>%
  mutate_at(vars(pente_eau_m_m, l_h),
            function(x) round(x, 5)) %>% 
  DT::datatable(caption = "Table 1 : Assemblage des données de l'IED Carhyce et des mesures de terrain réalisées par la DR OFB Bretagne. La variable `etiquette` est obtenue par concaténation de la référence de la station et du nom du cours d'eau car aucune de ces variables n'est renseignée dans 100% des cas. Elle sert à identifier les points sur les graphiques interactifs.")
```
L'interface cartographique ci-dessous présente la localisation des différentes stations étudiées, en distinguant les trois jeux de données.  
```{r, fig.width = 8, fig.height = 8, fig.cap = "Carte des sites prospectés."}
# mapview::mapview(donnees_carte,
#                  zcol = "Source",
#                  layer.name = "Source",
#                  popup = leafpop::popupTable(
#       donnees_carte,
#       zcol = c("Station",
#                "Source")))
test <-  mapview::mapview(donnees_carte,
    zcol = "Source",
    layer.name = "Source",
    popup = leafpop::popupTable(
      donnees_carte,
      zcol = c("Station",
               "Source"),
      feature.id = FALSE,
      row.numbers = FALSE
    )
  )

test@map
```


L'hypothèse sous-jacente aux analyses est que les variables de contrôle du bassin versant (exemple : superficie du bassin versant amont) contraignent les variables de réponse (ex : largeur à plein bord, hauteur à plein bord, etc) à l’échelle du cours d’eau (Malavoi & Bravard, 2010). Le phénomène est bien documenté sur les grands cours d'eau, mais les têtes de bassins ont été beaucoup moins étudiées. 

Les caractéristiques du bassin versant à l’amont de la station étudiée qui vont être utilisées dans cette analyse sont ainsi:

- La *superficie*, en km² du bassin versant qui s'étend en amont d'une station.
- La *pente.* Ici c'est la pente longitudinale de la ligne d'eau du cours d'eau au niveau de la station qui est prise comme *proxy* de la pente du bassin. Elle est exprimée en m/m.

Les variables de réponses sont *la largeur et la hauteur de plein bord* (moyennes sur l'ensemble des transects par station, exprimées en m) ainsi que le ratio entre la largeur à plein bord sur la hauteur à plein bord (rapport de forme).

# Distribution des variables

Les distributions des variables sont données ci-dessous en comparant les jeux de données afin de bien présenter les ordres de grandeur. Celles qui prennent des valeurs très dispersées sont représentées en échelle logarithmique $log$ (base 10).


```{r, fig.height = 10, fig.width = 10, fig.cap = "Distribution des variables. Les lignes verticales indiquent la valeur moyenne pour chaque jeu de données."}
g_densite
```

Les largeurs à plein bord du jeu de données "têtes de bassins" sont toutes inférieures à 5 m, avec une moyenne de l'ordre d'un mètre. Les largeurs à plein bord moyennes des données issues de Galineau (2000) et de Carhyce sont logiquement plus importantes ; respectivement de 6 m et 9 m.

Les écarts sont moins nets sur les hauteurs à plein bord mais le même ordre est observé. En moyenne elles sont de 0,3 (TBV), 0,6 (Galineau) et 0,9 m (CARHYCE).

Les écarts sont nettement plus importants en termes de surface du bassin versant, ce qui conduit à représenter les distributions en échelle log. Les ordres de grandeur pour les trois jeux de données précédents sont respectivement de 1, 10 et 100 km².

Les petits bassins (> 10 km²) sont marqués par des fortes pentes de la ligne d'eau.

Le rapport de forme (largeur/hauteur) est, en moyenne, inférieur dans le jeu de données "têtes de bassin" en comparaison des deux autres jeux de données (Galineau & Carhyce).


# Analyse bivariée

Dans un premier temps, on observe les relations des variables deux à deux.

## Les variables explicatives (de contrôle)

Sur le graphique ci-dessous, une droite de régression a été calée pour chacun des 3 jeux de données. La courbe grise en pointillés indique une tendance non linéaire sur l'ensemble des données.


```{r, fig.cap="Relation entre la pente de la ligne d'eau et la surface du bassin versant, distinguant les trois jeux de données."}
g_pente_sbv
```

En échelle log-log, le lien entre les deux variables explicatives est fort (sur l'ensemble des trois jeux de données, *r²*=$`r pente_sbv_r2`$, *p-value*=$`r pente_sbv_pvalue`$). Il est possible que la relation soit plutôt curvi-linéaire que linéaire. La relation est décroissante, et logiquement la pente est d'autant plus faible que la station étudiée est située en aval (bassin versant amont plus grand).

Les plus petits bassins sont bien ceux du jeu de données de référence (0,1 à 2,2 km²), les plus grands ceux de Carhyce(2,2 à 626,5 km²), et ceux de Galineau (2020) en position intermédiaire (3,9 à 72,8 km²). Dans ce premier graphique, une discontinuité de la pente en fonction de la surface du bassin-versant apparaît, certaines pentes de stations issues du jeu de données de référence sont assez faibles.

Quelques stations sont très éloignées du schéma général et méritent des vérifications (ex : Ref_0065, ou bien le Dolo dans Carhyce).

## Relation entre bassin et morphologie du lit

A commenter.

```{r, fig.cap="Relation entre la largeur à plein bords et la surface du bassin versant, distinguant les trois jeux de données."}
g_lpb_sbv
```


```{r, fig.cap="Relation entre la hauteur à plein bords et la surface du bassin versant, distinguant les trois jeux de données."}
g_hpb_sbv
```


```{r, fig.cap="Relation entre la largeur à plein bords et la pente de la ligne d'eau, distinguant les trois jeux de données."}
g_lpb_pente
```


```{r, fig.cap="Relation entre la hauteur à plein bords et la pente de la ligne d'eau, distinguant les trois jeux de données."}
g_hpb_pente
```





# Modélisation

## Modèles complets

Pour évaluer les effets combinés des deux variables explicatives (surface de bassin versant et pente), sur la largeur et la hauteur à plein bord des lits mineurs, des régressions multiples ont été réalisées. D'après les graphiques, les relations *log-log* semblent linéaires. Cependant, quelques essais montrent que les modèles sont mieux ajustés en ne transformant que les variables explicatives :

$x \rightarrow \log_{10}(1+x)$

L'ajout de 1 dans l'équation permet de conserver des valeurs positives ou nulles.

Ainsi, les modèles sont de la forme suivante :

$hauteur\ à\ plein\ bord = a\cdot log_{10}(1+surface\_bv) + b\cdot log_{10}(1+pente)+c$

```{r}
# chargement du tableau de données au format RData
load(file = "modeles.RData")

modeles %>% 
  rename(`Surface BV` = `log10(1 + Surface_BV_km2)`,
         `Pente` = `log10(1 + pente_eau_m_m)`,
          Constante = `(Intercept)`) %>% 
  mutate(r2 = round(r2, 2)) %>% 
  flextable() %>%
  set_table_properties(layout = "autofit", width = 1) %>% 
  align(j = c(1, 3:6), align = "center", part = "all") %>% 
  hline(i = 3)
```

La superficie du bassin versant amont présente des coefficients de corrélation toujours significatifs. Cette superficie constitue la principale variable qui contribue à expliquer la largeur et la hauteur du lit mineur d'un cours d'eau. Ces coefficients sont positifs, indiquant un effet taille : plus un bassin versant est grand, plus le cours d'eau est large et profond (Malavoi & Bravard, 2010).

L'effet de la pente n'est significatif que sur un modèle, avec une `p-value` entre `0.05` et `0.01`, ce qui n'est pas très convaincant. Il s'agit vraisemblablement d'une mauvaise estimation de ce coefficient, ce qui arrive quand les variables explicatives sont corrélées entre elles.Cela vient peut etre aussi du fait que la pente des stations ne suit pas le modèle conceptuel de décroissance vers l’aval (exemple des têtes de bassin versant à faible pente).

Les coefficients de détermination ajustés `r²` sont plus faibles pour les têtes de bassins versants que pour les deux autres jeux de données, malgré l'effet très significatif de la surface du bassin versant. Sur ces deux autres jeux de données, ils sont particulièrement élevés (`>0.90`) pour la largeur plein bord `Lpb`. Ils sont de l'ordre de `0.80` pour la hauteur plein bord `Hpb`.

## Modèles simplifiés

Dans un but de parcimonie, et pour s'affranchir des problèmes liés à la colinéarité entre variables explicatives, on peut simplifier les modèles en ne conservant que la surface du bassin versant comme variable explicative. On peut aussi essayer de combiner notre jeu de données avec les autres. Les résultats obtenus sont les suivants :

```{r}
modeles_simp %>% 
  rename(`Surface BV` = `log10(1 + Surface_BV_km2)`,
          Constante = `(Intercept)`) %>% 
  mutate(r2 = round(r2, 2)) %>% 
  flextable() %>%
  set_table_properties(layout = "autofit", width = 1) %>% 
  align(j = c(1, 3:5), align = "center", part = "all") %>% 
  hline(i = 5)
```

Ces modèles sont très cohérents. La perte sur le coefficient de détermination ajusté est négligeable en omettant la pente. Ces modèles semblent donc être les plus intéressants.

## modèles finaux

La seule variable explicative retenue est donc la surface du bassin versant. Les figures 4 et 6 suggèrent toutefois que la relation entre cette variable et les dimensions à plein bord du lit pourraient être curvilinéaires. Afin d'en tenir compte, on peut essayer d'ajouter au modèle un terme quadratique, c'est-à-dire de caler pour la hauteur plein bord :

$hauteur\ à\ plein\ bord = a_1\cdot log_{10}(1+surface\_bv) + a_2\cdot (log_{10}(1+surface\_bv))^2+b$

Les résultats n'apportent pas d'amélioration, donc le modèle final retenu est tel que :

>$hauteur\ à\ plein\ bord = a\cdot log_{10}(1+surface\_bv)+b$

Afin de le caler au mieux sur les têtes de bassins, on l'ajuste sur le jeu de données combiné restreint aux bassins inférieurs à 10 km² (Brummer & Montgomery, 2003 ; MacDonald & Coe, 2007). Au-delà de cette valeur il est préférable de se reporter à Carhyce.

```{r}
mf_lpb <- lm_unitaire(
  data = ref %>% filter(Surface_BV_km2 < 20),
  var_dep = "Lpb",
  jeu_donnees_selectionne = c("tbv_ref", "galineau_2020", "carhyce_ref_armo"),
  pente_incluse = FALSE
)

mf_hpb <- lm_unitaire(
  data = ref %>% filter(Surface_BV_km2 < 20),
  var_dep = "Hpb",
  jeu_donnees_selectionne = c("tbv_ref", "galineau_2020", "carhyce_ref_armo"),
  pente_incluse = FALSE
)

rbind(mf_lpb[[2]], mf_hpb[[2]]) %>% 
    as.data.frame() %>%
  rownames_to_column() %>%
  separate(
    col = rowname,
    into = c("Variable dépendante", "jeu_donnees"),
    sep = " / "
  ) %>% 
  select(-jeu_donnees) %>% 
    rename(`a (Surface BV)` = `log10(1 + Surface_BV_km2)`,
          `b (Constante)` = `(Intercept)`) %>% 
  mutate(r2 = round(r2, 2)) %>% 
  flextable() %>%
  set_table_properties(layout = "autofit", width = 1) %>% 
  align(align = "center", part = "all")
```


# Préconisations de dimensionnement

Dans le cadre d'une opération de restauration, il convient de privilégier le recours à des segments hydromorphologiques de référence présentant des caractéristiques similaires au site étudié (exemple : surface de bassin versant, géologie, relief, etc.). En l'abence de stations de référence, ce calculateur peut permettre de vérifier le dimensionnement de la largeur à plein bord du lit mineur obtenu par des calculs hydrauliques.La valeur présentée ne doit pas conduire à effectuer des reconstitutions de lits mineurs homogènes, il est en effet nécessaire de diversifier les largeurs et les profondeurs afin de concourir à la réussite du projet de restauration.  
```{r}
inputPanel(
  shiny::numericInput(
    "sbv",
    label = "Saisissez la surface de votre bassin versant, en km²",
    value = 1.5,
    step = 0.1
  )
)
```



```{r}
new_data <- reactive({
  data.frame(Surface_BV_km2 = input$sbv)
})
```


```{r}
output$pred_lpb <- renderText({ 
 raw_pred_lpb <-
    predict.lm(mf_lpb[[1]], newdata = new_data(), interval = "confidence")
  
 paste0("Largeur plein bord : ",
        round(raw_pred_lpb[1], 2),
        "m, IC = [",
        round(raw_pred_lpb[2], 2),
        "-",
        round(raw_pred_lpb[3], 2),
        "]")
})

output$pred_hpb <- renderText({ 
 raw_pred_hpb <-
    predict.lm(mf_hpb[[1]], newdata = new_data(), interval = "confidence")
  
 paste0("Hauteur plein bord : ",
        round(raw_pred_hpb[1], 2),
        "m, IC = [",
        round(raw_pred_hpb[2], 2),
        "-",
        round(raw_pred_hpb[3], 2),
        "]")
})
```

:::: {.colorbox data-latex=""}

Valeurs prédites par le modèle, avec entre crochets l'intervalle de confiance associé.

```{r}
verbatimTextOutput("pred_lpb")
verbatimTextOutput("pred_hpb")
```

::: {.center data-latex=""}

**ATTENTION**
:::
Ces valeurs ne doivent être utilisées qu’en l’absence de station de référence à l’amont immédiat du linéaire de cours d’eau étudié. De plus, les valeurs de géométrie du lit proposées par cet outil ne sont applicables que sur des bassins versants de moins de 10 km² et situés dans l'hydro-écorégion de niveau 1 "Massif Armoricain".
::::





